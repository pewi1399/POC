<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <!--<meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">-->
<link rel="stylesheet" type="text/css" href="stylesheets/bootstrap-3.3.7-dist/css/bootstrap.min.css" media="screen"> <!-- ordnar alignemnt av formulärfält bland annat -->
<link rel="stylesheet" href="stylesheets/font-awesome-4.6.3/css/font-awesome.min.css"> <!-- ger symboler exempelvis plustecken-->
	<!--<link rel="stylesheet"  href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.css" />--> <!-- select2 -->
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

	<style>
div.ex1 {
    width:500px;
    margin: auto;
}

div.ex2 {
    max-width:1200px;
    margin: auto;
    border: 3px solid #73AD21;
}

.tick > line {
    stroke: gainsboro;
}

.axis--x path {
  display: none;
}

.line {
  fill: none;
  stroke-width: 1.5px;
}
</style>
  </head>

  <body>

  	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/select2/4.0.3/js/select2.min.js"></script>
    <script type="text/javascript" src="src/tabletop.js"></script>

  <div class="ex1">
  Some text to make this easier to look at...
<p>&nbsp;</p>
  </div>

  <!--
Välj ut element
  $("#select2-multiple-input-sm").val()-->

 <div id="dropList"></div>
  <script type="text/javascript">

 var a1 = ["Pensionär", "Sparare"]
 var a2 = ["Hög", "Medel", "Låg"]
 var a3 = ["PM", "AMF", "IF", "SIF", "VIF", "Etc"]

 var alternatives = [a1, a2, a3]

// var data1 = {name:"book_1]", x:12}
// var data2 = {name:"book_1]", y:20}
// var data3 = {name:"book_2]", x:10}

var dataset = []//[{name:"book_1]", x:12},{name:"book_2]", x:1, y:12}];

/*
- topDiv = d3.select("#dropList")
    .append("div")

var selectors = topDiv.selectAll(".lists")
	.data(alternatives)
	.enter()
	.append("div")
	.attr("class", "col-md-4") //set class of divs
    .append("select")
	.attr("multiple", "multiple")
	.attr('id', function(d,i ) { return "test" + i;})
	.attr('class', "form-control input-sm select2-multiple" ) // set class of selectors
	  .call(function(parent){

	 for(j = 0; j < parent.data().length; j++){
    parent.append('option').text(function(d){ return d[j]; }).attr("value", function(d){ return d[j]; });

	}
	});

	//activate select2 on all
	//$("#test0").select2()
	//$("#test1").select2()
	//$("#test2").select2()

function get_primary_lineset(){

	var s1 = $("#test0").val();
	var s2 = $("#test1").val();
	var s3 = $("#test2").val();

	window.primary_lineset_groups = s1.concat(s2);
	window.primary_lineset_actors = s3;

}
*/
  </script>
<div class="ex2">
	<svg xmlns="http://www.w3.org/2000/svg"
    width="860"
    height="500"
    viewBox="0 0 860 500"
    preserveAspectRatio="xMinYMin meet">
	</svg>
<div>

<form id="bookForm" method="post" class="form-horizontal">
    <div class="form-group">
        <label class="col-xs-1 control-label">Serie</label>
        <div class="col-xs-3">
            <select type="text" class="form-control" name="book_0_.title"  id="book_0_.title" placeholder="Kundtyp" />
		          <option selected disabled hidden>Välj Kundtyp</option>
        			<option> Pensionar </option>
        			<option> Sparare </option>
            </select>
        </div>
        <div class="col-xs-3">
            <select type="text" class="form-control" name="book_0_.isbn" placeholder="ISBN" />
              <option selected disabled hidden>Välj Segment</option>
              <option> Hog </option>
        			<option> Medel </option>
              <option> Lag </option>
              <option> Kvinna </option>
              <option> Man </option>
            </select>
        </div>
        <div class="col-xs-3">
            <select type="text" class="form-control" name="book_0_.price" placeholder="Price" />
              <option selected disabled hidden>Välj Aktör</option>
              <option> Förtroende för AMF </option>
			        <option> Fortroende for Arbetsformedlingen </option>
              <option>Kannedom om CSN</option>
              <option>Pensionsmyndigheten ar kunniga</option>
              <option>Pensionsmyndigheten informerar om pensionen på ett satt som ar relevant for mig</option>
            </select>
	      </div>
        <div class="col-xs-1">
            <button type="button" class="btn btn-default addButton"><i class="fa fa-plus"></i></button>
        </div>
        <div class="col-xs-0">
          <svg width="35" height="35">
            <rect width="35" height="22" name = "book_0_.legend" fill = "white" stroke-width = 3 stroke = "black" />
            <text x = "5" y = "34" name = "book_0_.text" font-size = "11px">0.00</text>
          </svg>
        </div>
    </div>

    <!-- The template for adding new field -->
    <div class="form-group hide" id="bookTemplate">
        <div class="col-xs-3 col-xs-offset-1">
            <select type="text" class="form-control" name="title" placeholder="Title" />
      <option selected disabled hidden>Välj kundtyp</option>
			<option> Pensionar </option>
			<option> Sparare </option>
			</select>
        </div>
        <div class="col-xs-3">
            <select type="text" class="form-control" name="isbn" placeholder="ISBN" />
      <option selected disabled hidden>Välj segment</option>
			<option> Hog </option>
			<option> Medel </option>
      <option> Lag </option>
      <option> Kvinna </option>
      <option> Man </option>
			</select>
        </div>
        <div class="col-xs-3">
            <select type="text" class="form-control" name="price" placeholder="Price" />
      <option selected disabled hidden>Välj Aktör</option>
			<option> Fortroende for AMF </option>
			<option> Fortroende for Arbetsformedlingen </option>
      <option>Kannedom om CSN</option>
      <option>Pensionsmyndigheten ar kunniga</option>
      <option>Pensionsmyndigheten informerar om pensionen på ett satt som ar relevant for mig</option>
			</select>
        </div>
        <div class="col-xs-1">
            <button type="button" name = "remove" class="btn btn-default removeButton"><i class="fa fa-minus"></i></button>
        </div>
        <div class="col-xs-0">
          <svg width="35" height="35" class= "legendbox">
            <rect width="35" height="22" name = "legend" fill = "white" stroke-width = 3 stroke = "black" />
            <text x = "5" y = "34" name = "text" font-size = "11px">0.00</text>
          </svg>
        </div>
    </div>
    <!-- get rid of submit function if possible
    <div class="form-group">
        <div class="col-xs-5 col-xs-offset-1">
            <button type="submit" class="btn btn-default">Submit</button>
        </div>
    </div>
  -->
</form>


<!-- add row for saving selected data -->
<form id="download" method="post" class="form-horizontal">
<div class="form-group">
  <div class="col-xs-10">
  </div>
  <div class="col-xs-1">
      <button type="button" class="btn btn-default downloadButton">  <i class="fa fa-download" aria-hidden="true"></i> </button>
  </div>
  <div class="col-xs-1">
  </div>
</div>
</form>


<script>

            $('select[name^="book_' + 0 + '"]').on('change',function(){
                var existing_keys = dataset.map(function(d) { return d["name"]; });
                // test if key is already present in set of lines to be drawn.
                if(existing_keys.indexOf($(this).attr("name").substr(0,7))!=-1){
                  // find index of key and exend that part of df with custom json
                  var index = existing_keys.indexOf($(this).attr("name").substr(0,7))
                  var jsonString = '{"' + $(this).attr("name").substr(8,13) + '":"' + $(this).val() + '"}'
                  // update any existing key value pair, add any non existant
                  $.extend(dataset[index], dataset[index], JSON.parse(jsonString)); // update existing frame with data

                  // call d3 to draw line if set is complete
                  if($(".form-group select[name ^= 'book_"+ 0 +"']")
                    .filter(function(){return $.trim($(this).val()).length == 0})
                    .length == 0){

                      var kund = $(".form-group select[name ^= 'book_0_.title'").val(),
                          segment = $(".form-group select[name ^= 'book_0_.isbn'").val()
                          nyckel = $(".form-group select[name ^= 'book_0_.price'").val();

                          var color = d3.scaleLinear()
                              .domain([0, 100])
                              .range(["red", "violet"])
                              .interpolate(d3.interpolateCubehelix.gamma(3));
                          var rainbow = d3.scaleSequential(d3.interpolateRainbow);

                          var col = rainbow(Math.random());
                          drawFun_tmp(nyckel, segment, kund, col, 0);
                    }
                } else {
                  //if key is missing push object to array
                  dataset.push({name:$(this).attr("name").substr(0,7)})
                  // find index of key and exend that part of df with custom json
                  var index = existing_keys.indexOf($(this).attr("name").substr(0,7))
                  var jsonString = '{"' + $(this).attr("name").substr(8,13) + '":"' + $(this).val() + '"}'
                  // update any existing key value pair, add any non existant
                  $.extend(dataset[index], dataset[index], JSON.parse(jsonString)); // update existing frame with data
                };
              });

$(document).ready(function() {
    var bookIndex = 0;

    $('#bookForm')
        // Add button click handler
        .on('click', '.addButton', function() {
            bookIndex++;
            var $template = $('#bookTemplate'),
                $clone    = $template
                                .clone()
                                .removeClass('hide')
                                .removeAttr('id')
                                .attr('data-book-index', bookIndex)
                                .insertBefore($template);

            // Update the name attributes
            $clone
                .find('[name="title"]').attr('name', 'book_' + bookIndex + '_.title').end()
                .find('[name="isbn"]').attr('name', 'book_' + bookIndex + '_.isbn').end()
                .find('[name="price"]').attr('name', 'book_' + bookIndex + '_.price').end()
                .find('[name="text"]').attr('name', 'book_' + bookIndex + '_.text').end()
                .find('[name="legend"]').attr('name', 'book_' + bookIndex + '_.legend').end()
                .find('[name="remove"]').attr('name', 'book_' + bookIndex + '_.remove').end();

            // Add new fields
            // and listeners for changes in document
            $('#bookForm')
              $('select[name^="book_' + bookIndex + '"]').on('change',function(){
                var existing_keys = dataset.map(function(d) { return d["name"]; });
                drawerIndex = $(this).attr("name").replace(/[^\d-]/g, '');

                // test if key is already present in set of lines to be drawn.
                if(existing_keys.indexOf($(this).attr("name").substr(0,7))!=-1){
                  // find index of key and exend that part of df with custom json
                  var index = existing_keys.indexOf($(this).attr("name").substr(0,7))
                  var jsonString = '{"' + $(this).attr("name").substr(8,13) + '":"' + $(this).val() + '"}'
                  // update any existing key value pair, add any non existant
                  $.extend(dataset[index], dataset[index], JSON.parse(jsonString)); // update existing frame with data

                  // call d3 to draw line if set is complete
                  if($(".form-group select[name ^= 'book_"+ drawerIndex +"']")
                    .filter(function(){return $.trim($(this).val()).length == 0})
                    .length == 0){
                      var kund = $(".form-group select[name ^= 'book_"+ drawerIndex +"_.title'").val(),
                          segment = $(".form-group select[name ^= 'book_"+ drawerIndex +"_.isbn'").val()
                          nyckel = $(".form-group select[name ^= 'book_"+ drawerIndex +"_.price'").val();

                          var color = d3.scaleLinear()
                              .domain([0, 100])
                              .range(["red", "violet"])
                              .interpolate(d3.interpolateCubehelix.gamma(3));
                          var rainbow = d3.scaleSequential(d3.interpolateRainbow);

                          var col = rainbow(Math.random());
                          drawFun_tmp(nyckel, segment, kund, col, drawerIndex);
                          //$("svg rect[name ^= 'book_" + drawerIndex + "_.legend']").attr("fill", col)

                      }//alert("draw1");
                } else {
                  //if key is missing push object to array
                  dataset.push({name:$(this).attr("name").substr(0,7)})
                  // find index of key and exend that part of df with custom json
                  var index = existing_keys.indexOf($(this).attr("name").substr(0,7))
                  var jsonString = '{"' + $(this).attr("name").substr(8,13) + '":"' + $(this).val() + '"}'
                  // update any existing key value pair, add any non existant
                  $.extend(dataset[index], dataset[index], JSON.parse(jsonString)); // update existing frame with data
                };
              });
              //$('select[name^="book_' + bookIndex + '_.isbn"').on('change',function(){console.log($(this).val())});
              //$('select[name^="book_' + bookIndex + '_.price"').on('change',function(){console.log($(this).val())});
            })

        // Remove button click handler
        .on('click', '.removeButton', function() {
            var $row  = $(this).parents('.form-group'),
                index = $row.attr('data-book-index');

            // Remove fields
            $('#bookForm')
				/*
				$row.find('[name="book_' + index + '_.title"]').remove()
				$row.find('[name="book_' + index + '_.isbn"]').remove()
				$row.find('[name="book_' + index + '_.price"]').remove()
*/
            // Remove element containing the fields
            $row.remove();

            d3.selectAll("[name = '" + index + "']").remove()

        });

        $(".downloadButton").on('click', function(){

          JSONToCSVConvertor(data, "download", "date")

        }
      )


});
</script>



<script type="text/javascript" src="javascript/imgMatning.js"></script>
<script type="text/javascript" src="sandbox.js"></script>

</body>
